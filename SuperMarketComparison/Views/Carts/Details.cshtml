@model SuperMarketComparison.Models.Cart

@{
    ViewData["Title"] = "Details";
}

<h3><i class="fa-solid fa-cart-shopping"></i> My Shopping Cart</h3>

<table class="table table-hover">
    <thead>
        <tr>
            <th>
                <a
                    style="text-decoration:none"
                    class="fw-bold text-black"
                    asp-action="Details"
                    asp-route-id="@Model.Id"
                    asp-route-sortOrder="@ViewBag.NameSortParam"
                >
                    <i class="fa-solid fa-sort"></i>
                    Item
                    @if (ViewBag.CurrentSort == "name_asc")
                    {
                        <span>(A-Z)</span>
                    }
                    else if (ViewBag.CurrentSort == "name_desc")
                    {
                        <span>(Z-A)</span>
                    }
                </a>
            </th>

            <th>Added</th>
            <th>Qty.</th>
            <th>Min Price</th>
            <th>Max Price</th>
            <th class="text-end">Action</th>
        </tr>
    </thead>

    <tbody>
        <tr>
            <td>
                <a asp-controller="Carts"
                   asp-action="Add"
                   asp-route-id="@Model.Id"
                   class="btn btn-sm btn-primary">
                    <i class="fa-solid fa-plus text-white"></i>
                    Item
                </a>
            </td>
            <td>-</td>
            <td>-</td>
            <td class="bg-success-subtle">-</td>
            <td class="bg-danger-subtle">-</td>
            <td class="text-end">-</td>
        </tr>

        @foreach (var item in Model.CartItems)
        {
            var currentItem = item.ItemStorePrice.Item;
            var allPrices = currentItem?.Prices;

            var minPrice = allPrices.Any() ? allPrices.Min(p => p.Price) : (decimal?)null;
            var maxPrice = allPrices.Any() ? allPrices.Max(p => p.Price) : (decimal?)null;

            <tr>
                @* ITEM name *@
                <td>@currentItem?.Name</td>

                @* ITEM marked *@
                <td>
                    <input
                        type="checkbox"
                        data-cartitem-id="@item.Id"
                        @(item.IsChecked ? "checked" : "") 
                        style="transform: scale(2);"                        
                    />
                </td>

                @* Quantity of ITEMs *@
                <td>                    
                    <div 
                        class="input-group input-group-sm"
                        style="max-width:50px; display:inline-flex"
                    >
                        <input 
                            type="number" 
                            class="form-control quantity-input" 
                            step="1"
                            min="1"
                            value="@item.Quantity"
                            data-cart-item-id="@item.Id"
                            data-cart-id="@item.CartId"
                        />
                    </div>
                </td>

                @* ITEM minumum price *@
                <td class="bg-success-subtle">
                    @if (minPrice.HasValue)
                    {
                        <span>@((minPrice * item.Quantity)?.ToString("N2")) €</span>
                    }
                </td>

                @* ITEM maximum price *@
                <td class="bg-danger-subtle">
                    @if (maxPrice.HasValue)
                    {
                        <span>@((maxPrice * item.Quantity)?.ToString("N2") ?? "N/A") €</span>
                    }
                </td>

                @* DELETE ITEM from cart *@
                <td class="text-end">
                    <form 
                        asp-action="Delete" 
                        asp-route-id="@item.Id" 
                        asp-route-cartId="@item.CartId"
                        method="post" 
                        onsubmit="return confirm('Are you sure you want to delete this item?');"
                    >
                        <input type="submit" class="btn btn-sm btn-danger" value="Delete" />
                    </form>
                </td>
            </tr>
        } 

        @* TOTAL: sum of min price, sum of max price *@
        <tr>
            <td class="fw-bold">TOTAL:</td>
            <td>-</td>
            <td>-</td>
            <td class="fw-bold bg-success-subtle">@ViewBag.TotalMin.ToString("N2") €</td>
            <td class="fw-bold bg-danger-subtle">@ViewBag.TotalMax.ToString("N2") €</td>
            <td class="text-end">-</td>
        </tr>
    </tbody>
</table>

<div class="mt-2">
    <a asp-action="Index" class="btn btn-secondary">Back to Carts</a>
</div>

@section Scripts{
    <script>
    document.querySelectorAll(".quantity-input").forEach(input => {
        input.addEventListener("change", async (e) => {
            const cartItemId = e.target.dataset.cartItemId;
            const cartId = e.target.dataset.cartId;
            const quantity = e.target.value;

            try {
                const res = await fetch("/Carts/UpdateQuantity", {
                    method:"POST",
                    headers: {
                        "Content-Type": "application/json",
                        "RequestVerificationToken":
                            document.querySelector("input[name='__RequestVerificationToken']").value
                    },
                        body: JSON.stringify({ id: cartItemId, cartId: cartId, quantity: quantity })
                });

                if (!res.ok) {
                    console.error("Failed to update quantity");
                }
            } catch (err) {
                console.error(err);
            }
        });
    });
    </script>
}